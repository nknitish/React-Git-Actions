name: Log Merged PRs

on:
  pull_request:
    types: [closed]

jobs:
  log-merged-pr:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Install jq (if not present)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ§¾ Create PR log entry JSON file
        run: |
          cat <<EOF > pr-entry.json
{
  "number": ${{ github.event.pull_request.number }},
  "title": "${{ github.event.pull_request.title }}",
  "author": "${{ github.event.pull_request.user.login }}",
  "branch": "${{ github.event.pull_request.head.ref }}",
  "merged_at": "${{ github.event.pull_request.merged_at }}"
}
EOF

      - name: ğŸ§© Merge with existing PR log
        run: |
          FILE=merged-prs.json
          if [ ! -f "$FILE" ]; then
            echo "[]" > $FILE
          fi

          jq --slurpfile new pr-entry.json '. + $new' $FILE > tmp.json
          mv tmp.json $FILE

      - name: âœ… Commit and push PR log update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add merged-prs.json
          git commit -m "ğŸ“ Log merged PR #${{ github.event.pull_request.number }}"
          git push

