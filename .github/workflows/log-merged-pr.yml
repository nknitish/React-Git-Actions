name: Log Merged PRs

on:
  pull_request:
    types: [closed]

jobs:
  log-pr:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🧾 Create PR log entry
        run: |
          echo "{
            \"number\": ${PR_NUMBER},
            \"title\": \"${{ github.event.pull_request.title }}\",
            \"author\": \"${{ github.event.pull_request.user.login }}\",
            \"branch\": \"${{ github.event.pull_request.head.ref }}\",
            \"merged_at\": \"${{ github.event.pull_request.merged_at }}\"
          }," > pr-entry.json
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: 🧩 Merge with existing PR log
        run: |
          FILE=merged-prs.json
          if [ ! -f "$FILE" ]; then
            echo "[]" > $FILE
          fi

          cat $FILE | jq '. |= [input] + .' pr-entry.json > tmp.json
          mv tmp.json $FILE

      - name: ✅ Commit and push PR log
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add merged-prs.json
          git commit -m "📝 Log merged PR #${{ github.event.pull_request.number }}"
          git push
